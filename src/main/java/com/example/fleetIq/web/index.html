<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Tracks</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; }
        table { width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body class="p-4 bg-gray-100">
<h1 class="text-2xl font-bold mb-4">Device Tracks</h1>

<div class="mb-4">
    <form id="filterForm" class="flex space-x-4">
        <div>
            <label for="imei" class="block text-sm font-medium">Select IMEI</label>
            <select id="imei" class="border rounded p-1">
                <!-- Populated dynamically -->
            </select>
        </div>
        <div>
            <label for="beginTime" class="block text-sm font-medium">Start Time (YYYY-MM-DD HH:MM)</label>
            <input type="datetime-local" id="beginTime" class="border rounded p-1">
        </div>
        <div>
            <label for="endTime" class="block text-sm font-medium">End Time (YYYY-MM-DD HH:MM)</label>
            <input type="datetime-local" id="endTime" class="border rounded p-1">
        </div>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Filter</button>
    </form>
</div>

<div id="map" class="mb-4"></div>

<table class="table-auto">
    <thead>
    <tr>
        <th>IMEI</th>
        <th>Time</th>
        <th>Latitude</th>
        <th>Longitude</th>
    </tr>
    </thead>
    <tbody id="deviceTable"></tbody>
</table>

<script>
    // Initialize Leaflet map
    const map = L.map('map').setView([-8.0, -79.0], 6); // Center on Peru
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Generate random color for each device
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // Format Unix timestamp to local datetime
    function formatDate(timestamp) {
        return new Date(timestamp * 1000).toLocaleString('en-US', { timeZone: 'America/Lima' });
    }

    // Fetch IMEIs for dropdown
    async function fetchImeis() {
        const baseUrl = 'http://localhost:8080';
        const url = new URL('/api/devices', baseUrl);

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const devices = await response.json();

            const select = document.getElementById('imei');
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.imei;
                option.textContent = device.imei;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching IMEIs:', error);
            alert('Failed to load IMEIs: ' + error.message);
        }
    }

    // Fetch and display tracks for selected IMEI
    async function fetchTracks(imei, beginTime, endTime) {
        const baseUrl = 'http://localhost:8080';
        const url = new URL('/api/tracks', baseUrl);
        url.searchParams.append('imei', imei);
        if (beginTime) url.searchParams.append('beginTime', beginTime);
        if (endTime) url.searchParams.append('endTime', endTime);

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            // Clear existing track layers
            map.eachLayer(layer => {
                if (layer instanceof L.Polyline || layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Process tracks
            const color = getRandomColor();
            const coords = data.map(track => [track.latitude, track.longitude]);
            const polyline = L.polyline(coords, { color }).addTo(map);

            // Add popup to each track point
            data.forEach(track => {
                L.marker([track.latitude, track.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <b>IMEI: ${imei}</b><br>
                        Time: ${formatDate(track.gpstime)}<br>
                        Latitude: ${track.latitude}<br>
                        Longitude: ${track.longitude}
                    `);
            });

            // Fit map to bounds of this device's tracks
            if (coords.length > 0) {
                map.fitBounds(coords);
            }

            // Populate table
            const tableBody = document.getElementById('deviceTable');
            tableBody.innerHTML = ''; // Clear table
            data.forEach(track => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${imei}</td>
                    <td>${formatDate(track.gpstime)}</td>
                    <td>${track.latitude}</td>
                    <td>${track.longitude}</td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching tracks:', error);
            alert('Failed to load tracks: ' + error.message);
        }
    }

    // Handle form submission
    document.getElementById('filterForm').addEventListener('submit', event => {
        event.preventDefault();
        const imei = document.getElementById('imei').value;
        const beginTime = document.getElementById('beginTime').value
            ? Math.floor(new Date(document.getElementById('beginTime').value).getTime() / 1000)
            : null;
        const endTime = document.getElementById('endTime').value
            ? Math.floor(new Date(document.getElementById('endTime').value).getTime() / 1000)
            : null;
        fetchTracks(imei, beginTime, endTime);
    });

    // Load IMEI options on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await fetchImeis();
    });
</script>
</body>
</html>